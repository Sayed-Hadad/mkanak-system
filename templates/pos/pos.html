
{% extends 'base.html' %}
{% block content %}
<div class="container-fluid" dir="rtl">
    <div class="row mt-4">
        <div class="col-lg-7"> <!-- ØªÙƒØ¨ÙŠØ± Ø¹Ø±Ø¶ Ø³Ù„Ø© Ø§Ù„Ø¨ÙŠØ¹ -->
            <div class="card shadow-sm mb-3">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-cart4"></i> Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨ÙŠØ¹ - ÙØ±Ø¹ {{ current_user.get_branch_name() }}</h5>
                </div>
                <div class="card-body">
                    <!-- Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†ØªØ¬ -->
                    <div class="input-group mb-3">
                        <input type="text" class="form-control form-control-lg text-end" id="product-search" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†ØªØ¬ Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯...">
                        <button class="btn btn-outline-secondary" type="button" id="scan-barcode-btn"><i class="bi bi-upc-scan"></i> Ù…Ø³Ø­ Ø¨Ø§Ø±ÙƒÙˆØ¯</button>
                    </div>
                    <!-- Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø« -->
                    <div id="search-results" class="list-group mb-3"></div>
                </div>
            </div>
        </div>
        <div class="col-lg-5"> <!-- ØªÙ‚Ù„ÙŠÙ„ Ø¹Ø±Ø¶ Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø³Ù„Ø© -->
            <!-- Ù…Ù„Ø®Øµ Ø§Ù„ÙŠÙˆÙ… -->
            <div class="card shadow-sm mb-3">
                <div class="card-header bg-info text-white">
                    <i class="bi bi-bar-chart-line"></i> Ù…Ù„Ø®Øµ Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ÙŠÙˆÙ…
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between mb-2">
                        <span>Ø¹Ø¯Ø¯ Ø§Ù„ÙÙˆØ§ØªÙŠØ±:</span>
                        <span class="fw-bold">{{ sales_count or 0 }}</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª:</span>
                        <span class="fw-bold text-success">{{ '%.2f'|format(total_sales or 0) }} Ø¬.Ù…</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª:</span>
                        <span class="fw-bold text-danger">{{ '%.2f'|format(total_discount or 0) }} Ø¬.Ù…</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙÙˆØ¹:</span>
                        <span class="fw-bold text-primary">{{ '%.2f'|format(total_paid or 0) }} Ø¬.Ù…</span>
                    </div>
                </div>
            </div>
            <!-- Ù†Ù‡Ø§ÙŠØ© Ù…Ù„Ø®Øµ Ø§Ù„ÙŠÙˆÙ… -->
            <div class="card shadow-sm mb-3">
                <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                    <h6 class="mb-0"><i class="bi bi-basket"></i> Ø³Ù„Ø© Ø§Ù„Ø¨ÙŠØ¹</h6>
                    <a href="{{ url_for('pos.sales_list') }}" class="btn btn-outline-light btn-sm"><i class="bi bi-receipt"></i> Ø§Ù„ÙÙˆØ§ØªÙŠØ±</a>
                </div>
                <div class="card-body">
                    <div id="cart-items"></div>
                    <hr>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</span>
                        <span class="fw-bold" id="cart-total">0.00</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>Ø§Ù„Ø®ØµÙ…:</span>
                        <input type="number" class="form-control form-control-sm w-50 text-end" id="cart-discount" value="0" min="0">
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø³ØªØ­Ù‚:</span>
                        <span class="fw-bold text-primary" id="cart-payable">0.00</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>Ù†ÙˆØ¹ Ø§Ù„Ø¨ÙŠØ¹:</span>
                        <select id="sale-type" class="form-select form-select-sm w-50 text-end">
                            <option value="cash">Ù†Ù‚Ø¯ÙŠ</option>
                            <option value="credit">Ø¢Ø¬Ù„ (Ø¯ÙØªØ±)</option>
                        </select>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>Ø§Ù„ØªØ§Ø¬Ø±/Ø§Ù„Ø¹Ù…ÙŠÙ„:</span>
                        <input type="text" class="form-control form-control-sm w-50 text-end" id="customer-name" placeholder="Ø§Ø³Ù… Ø§Ù„ØªØ§Ø¬Ø± Ø£Ùˆ Ø§Ù„Ø¹Ù…ÙŠÙ„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„:</span>
                        <input type="text" class="form-control form-control-sm w-50 text-end" id="customer-phone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>Ù…Ù„Ø§Ø­Ø¸Ø©:</span>
                        <input type="text" class="form-control form-control-sm w-50 text-end" id="sale-note" placeholder="Ø£Ø¯Ø®Ù„ Ø¬Ù…Ù„Ø© Ø£Ùˆ ØªØ¹Ù„ÙŠÙ‚ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
                    </div>
                    <button class="btn btn-success w-100 btn-lg mt-3" id="checkout-btn"><i class="bi bi-cash-coin"></i> Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø¨ÙŠØ¹</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Ù†Ø§ÙØ°Ø© Ù…Ø³Ø­ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ (Ù„Ø§Ø­Ù‚Ø§Ù‹) -->
</div>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
<style>
/* ØªÙƒØ¨ÙŠØ± Ø¹Ø±Ø¶ Ø³Ù„Ø© Ø§Ù„Ø¨ÙŠØ¹ */
#cart-items .d-flex {
    font-size: 1.15rem;
    padding: 8px 0;
}
#cart-items .fw-bold {
    font-size: 1.1rem;
}
#cart-items .btn {
    font-size: 1rem;
    padding: 2px 8px;
}
</style>
<script>
let products = [];
let cart = [];

// Ø¬Ù„Ø¨ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…ØªÙˆÙØ±Ø© ÙÙŠ Ø§Ù„ÙØ±Ø¹
async function fetchProducts() {
    const res = await fetch('/pos/api/products');
    products = await res.json();
}

// Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†ØªØ¬
function searchProducts(query) {
    query = query.trim().toLowerCase();
    if (!query) return [];
    return products.filter(p =>
        (p.name && p.name.toLowerCase().includes(query)) || (p.barcode && p.barcode.includes(query))
    );
}

// Ø¹Ø±Ø¶ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«
function renderSearchResults(results) {
    const resultsDiv = document.getElementById('search-results');
    resultsDiv.innerHTML = '';
    if (results.length === 0) {
        resultsDiv.innerHTML = '<div class="alert alert-warning text-center">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù†ØªØ¬ Ù…Ø·Ø§Ø¨Ù‚ Ù„Ù„Ø¨Ø­Ø«</div>';
        return;
    }
    results.forEach(p => {
        const item = document.createElement('button');
        item.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center';
        item.innerHTML = `<span class='fw-bold'>${p.name}</span><span class='badge bg-primary'>${p.price} Ø¬.Ù…</span> <span class='text-muted small'>Ø¨Ø§Ø±ÙƒÙˆØ¯: ${p.barcode}</span> <button class='btn btn-sm btn-outline-dark ms-2' onclick='event.stopPropagation();showBarcode("${p.barcode}")'><i class='bi bi-upc'></i></button>`;
        item.onclick = () => addToCart(p.id);
        resultsDiv.appendChild(item);
    });
}

// Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù†ØªØ¬ Ù…Ù† Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø« Ø£Ùˆ Ø¥Ø¯Ø®Ø§Ù„ Ø¨Ø§Ø±ÙƒÙˆØ¯ØŒ Ø£Ø¶ÙÙ‡ Ù„Ù„Ø³Ù„Ø© ÙˆØ§ÙØ±Øº Ø®Ø§Ù†Ø© Ø§Ù„Ø¨Ø­Ø«
function addToCart(productId) {
    const prod = products.find(p => p.id === productId);
    if (!prod) return;
    let item = cart.find(i => i.id === productId);
    if (item) {
        if (item.quantity < prod.quantity) {
            item.quantity++;
        }
    } else {
        cart.push({ ...prod, quantity: 1 });
    }
    renderCart();
    // ØªÙØ±ÙŠØº Ø®Ø§Ù†Ø© Ø§Ù„Ø¨Ø­Ø« ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
    document.getElementById('product-search').value = '';
    document.getElementById('search-results').innerHTML = '';
    document.getElementById('product-search').focus();
}

// Ø¹Ø±Ø¶ Ø§Ù„Ø³Ù„Ø©
function renderCart() {
    const cartDiv = document.getElementById('cart-items');
    cartDiv.innerHTML = '';
    if (cart.length === 0) {
        cartDiv.innerHTML = '<div class="alert alert-info text-center">Ø³Ù„Ø© Ø§Ù„Ø¨ÙŠØ¹ ÙØ§Ø±ØºØ©</div>';
        return;
    }
    cart.forEach(item => {
        const row = document.createElement('div');
        row.className = 'd-flex justify-content-between align-items-center mb-2 border-bottom pb-1';
        row.innerHTML = `
            <span class='fw-bold'>${item.name}</span>
            <div>
                <button class='btn btn-sm btn-outline-secondary' onclick='changeQty(${item.id}, -1)'>-</button>
                <span class='mx-2'>${item.quantity}</span>
                <button class='btn btn-sm btn-outline-secondary' onclick='changeQty(${item.id}, 1)'>+</button>
                <span class='ms-3 text-success fw-bold'>${(item.price * item.quantity).toFixed(2)} Ø¬.Ù…</span>
                <button class='btn btn-sm btn-outline-dark ms-2' onclick='showBarcode("${item.barcode}")'><i class='bi bi-upc'></i></button>
                <button class='btn btn-sm btn-outline-danger ms-2' onclick='removeFromCart(${item.id})'><i class='bi bi-trash'></i></button>
            </div>
        `;
        cartDiv.appendChild(row);
    });
    updateTotals();
}

// ØªØºÙŠÙŠØ± ÙƒÙ…ÙŠØ© Ù…Ù†ØªØ¬ ÙÙŠ Ø§Ù„Ø³Ù„Ø©
function changeQty(productId, delta) {
    let item = cart.find(i => i.id === productId);
    const prod = products.find(p => p.id === productId);
    if (!item || !prod) return;
    let newQty = item.quantity + delta;
    if (newQty < 1) newQty = 1;
    if (newQty > prod.quantity) newQty = prod.quantity;
    item.quantity = newQty;
    renderCart();
}

// Ø¥Ø²Ø§Ù„Ø© Ù…Ù†ØªØ¬ Ù…Ù† Ø§Ù„Ø³Ù„Ø©
function removeFromCart(productId) {
    cart = cart.filter(i => i.id !== productId);
    renderCart();
}

// ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ
function updateTotals() {
    let total = cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
    document.getElementById('cart-total').textContent = total.toFixed(2);
    let discount = parseFloat(document.getElementById('cart-discount').value) || 0;
    let payable = total - discount;
    if (payable < 0) payable = 0;
    document.getElementById('cart-payable').textContent = payable.toFixed(2);
}

// Ø¹Ù†Ø¯ Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø¨ÙŠØ¹ØŒ Ø£Ø±Ø³Ù„ Ù†ÙˆØ¹ Ø§Ù„Ø¨ÙŠØ¹ ÙˆØ§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙˆØ§Ù„Ù…Ù„Ø§Ø­Ø¸Ø© Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
async function checkout() {
    if (cart.length === 0) {
        alert('Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©!');
        return;
    }
    let discount = parseFloat(document.getElementById('cart-discount').value) || 0;
    let paid = parseFloat(document.getElementById('cart-payable').textContent) || 0;
    let saleType = document.getElementById('sale-type').value;
    let customerName = document.getElementById('customer-name').value.trim();
    let saleNote = document.getElementById('sale-note').value.trim();
    let customerPhone = document.getElementById('customer-phone').value.trim();
    const res = await fetch('/pos/api/checkout', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({items: cart, discount, paid, sale_type: saleType, customer_name: customerName, customer_phone: customerPhone, note: saleNote})
    });
    const data = await res.json();
    if (data.success) {
        alert('ØªÙ…Øª Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¨ÙŠØ¹ Ø¨Ù†Ø¬Ø§Ø­!');
        printReceipt(cart, discount, paid, customerName, saleType, saleNote);
        cart = [];
        renderCart();
        document.getElementById('product-search').value = '';
        document.getElementById('search-results').innerHTML = '';
        await fetchProducts();
    } else {
        alert(data.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¨ÙŠØ¹');
    }
}
document.getElementById('checkout-btn').addEventListener('click', checkout);

function showBarcode(barcode) {
    if (!barcode) { alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨Ø§Ø±ÙƒÙˆØ¯'); return; }
    const img = document.createElement('img');
    img.src = `/static/barcodes/${barcode}.png`;
    img.style.maxWidth = '300px';
    img.style.display = 'block';
    img.style.margin = '20px auto';
    const win = window.open('', '_blank');
    win.document.write('<h3>Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø§Ù„Ù…Ù†ØªØ¬</h3>');
    win.document.body.appendChild(img);
}

// Ø¯Ø§Ù„Ø© Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø©
function printReceipt(cart, discount, paid, customerName, saleType, saleNote) {
    const branchName = document.querySelector('.card-header.bg-primary')?.textContent.trim() || '';
    const cashier = '{{ current_user.full_name or current_user.username }}';
    const now = new Date();
    const dateStr = now.toLocaleDateString('ar-EG') + ' ' + now.toLocaleTimeString('ar-EG');
    const invoiceNum = Math.floor(Math.random() * 1000000); // Ø±Ù‚Ù… Ø¹Ø´ÙˆØ§Ø¦ÙŠ Ù…Ø¤Ù‚Øª
    // Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„ÙØ±ÙˆØ¹
    let branchAddress = '';
    if (branchName.includes('Ø¹Ø¨Ø¯ Ø§Ù„Ø¹Ø²ÙŠØ²')) {
        branchAddress = 'Ø¯Ø³ÙˆÙ‚ Ø´Ø§Ø±Ø¹ Ø¹Ø¨Ø¯ Ø§Ù„Ø¹Ø²ÙŠØ² / Ù Ù¤Ù§Ù¢Ù¥Ù¥Ù Ù£Ù Ù¥';
    } else if (branchName.includes('Ø§Ù„Ù…Ø±ÙƒØ²')) {
        branchAddress = 'Ø¯Ø³ÙˆÙ‚ Ø´Ø§Ø±Ø¹ Ø§Ù„Ù…Ø±ÙƒØ² / Ù Ù¤Ù§Ù¢Ù¥Ù¥Ù¥Ù¥Ù¢Ù¤';
    } else if (branchName.includes('ÙƒÙØ± Ø§Ù„Ø´ÙŠØ®')) {
        branchAddress = 'ÙƒÙØ± Ø§Ù„Ø´ÙŠØ® - Ø´Ø§Ø±Ø¹ Ø§Ù„Ù…ØµÙ†Ø¹ Ø¨Ø¬ÙˆØ§Ø± Ø§Ø¨Ø±Ø§Ø¬ Ø§Ù„Ø¬Ø¨Ø§Ù„ÙŠ / Ù Ù¤Ù§Ù£Ù¢Ù¢Ù¢Ù©Ù£Ù¥';
    } else {
        branchAddress = '';
    }
    let html = `<div style='font-family: Cairo, Arial, sans-serif; width:320px; margin:auto; text-align:center;'>`;
    html += `<img src='/static/logo2.png' style='max-width:90px; margin-bottom:8px; border-radius:8px;'>`;
    html += `<h3 style='margin:0 0 4px 0; letter-spacing:1px; color:#222;'>ÙØ§ØªÙˆØ±Ø© Ø¨ÙŠØ¹</h3>`;
    html += `<div style='font-size:15px; font-weight:bold; color:#0d6efd;'>${branchName}</div>`;
    if (branchAddress) html += `<div style='font-size:12px; color:#444; margin-bottom:2px;'>${branchAddress}</div>`;
    html += `<div style='font-size:12px; color:#555;'>${dateStr} | Ø±Ù‚Ù…: ${invoiceNum}</div>`;
    html += `<div style='font-size:12px; color:#555; margin-bottom:4px;'>Ø§Ù„ÙƒØ§Ø´ÙŠØ±: ${cashier}</div>`;
    html += `<table style='width:100%; border-collapse:collapse; margin-bottom:10px; font-size:13px;'>`;
    html += `<tr style='background:#f2f2f2; color:#222;'>`;
    html += `<th style='border:1px solid #eee; padding:4px;'>Ø§Ù„Ù…Ù†ØªØ¬</th><th style='border:1px solid #eee; padding:4px;'>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th style='border:1px solid #eee; padding:4px;'>Ø§Ù„Ø³Ø¹Ø±</th>`;
    html += `</tr>`;
    cart.forEach(item => {
        html += `<tr>`;
        html += `<td style='border:1px solid #eee; padding:4px;'>${item.name}</td>`;
        html += `<td style='border:1px solid #eee; padding:4px;'>${item.quantity}</td>`;
        html += `<td style='border:1px solid #eee; padding:4px;'>${(item.price * item.quantity).toFixed(2)} Ø¬.Ù…</td>`;
        html += `</tr>`;
    });
    html += `</table>`;
    html += `<div style='border-top:1px dashed #bbb; margin:8px 0;'></div>`;
    let total = cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
    html += `<div style='font-size:15px; text-align:right; color:#222; margin-bottom:2px;'>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: <b>${total.toFixed(2)} Ø¬.Ù…</b></div>`;
    html += `<div style='font-size:13px; text-align:right; color:#444;'>Ø§Ù„Ø®ØµÙ…: <b>${discount.toFixed(2)} Ø¬.Ù…</b></div>`;
    html += `<div style='font-size:13px; text-align:right; color:#444;'>Ø§Ù„Ù…Ø¯ÙÙˆØ¹: <b>${paid.toFixed(2)} Ø¬.Ù…</b></div>`;
    html += `<div style='font-size:13px; text-align:right; color:#444;'>Ø§Ù„Ø¨Ø§Ù‚ÙŠ: <b>${(total-discount-paid).toFixed(2)} Ø¬.Ù…</b></div>`;
    html += `<div style='margin:10px 0 0 0; font-size:13px; color:#0d6efd; font-weight:bold;'>Ø´ÙƒØ±Ø§Ù‹ Ù„ØªØ¹Ø§Ù…Ù„ÙƒÙ… Ù…Ø¹Ù†Ø§! ğŸŒŸ</div>`;
    html += `<div style='font-size:12px; color:#888; margin-top:4px;'>Ù†ØªÙ…Ù†Ù‰ Ù„ÙƒÙ… ÙŠÙˆÙ…Ù‹Ø§ Ø³Ø¹ÙŠØ¯Ù‹Ø§</div>`;
    html += `<div style='font-size:12px; margin-top:6px;'>Ù†ÙˆØ¹ Ø§Ù„Ø¨ÙŠØ¹: ${saleType === 'cash' ? 'Ù†Ù‚Ø¯ÙŠ' : 'Ø¢Ø¬Ù„ (Ø¯ÙØªØ±)'}</div>`;
    if (customerName) html += `<div style='font-size:12px;'>Ø§Ù„Ø¹Ù…ÙŠÙ„/Ø§Ù„ØªØ§Ø¬Ø±: ${customerName}</div>`;
    if (saleNote) html += `<div style='font-size:12px;'>Ù…Ù„Ø§Ø­Ø¸Ø©: ${saleNote}</div>`;
    html += `</div>`;
    let win = window.open('', '_blank', 'width=350,height=600');
    win.document.write(html);
    setTimeout(() => {
        win.print();
        setTimeout(() => {
            win.close();
            location.reload();
        }, 1500);
    }, 800);
}

document.addEventListener('DOMContentLoaded', async function() {
    await fetchProducts();
    // Ø§Ù„Ø¨Ø­Ø« Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
    document.getElementById('product-search').addEventListener('input', function() {
        const results = searchProducts(this.value);
        renderSearchResults(results);
    });
    // Ø¥Ø¶Ø§ÙØ© ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ø¹Ù†Ø¯ Ù…Ø³Ø­ Ø¨Ø§Ø±ÙƒÙˆØ¯ (Enter Ø£Ùˆ Ø·ÙˆÙ„ 12 Ø±Ù‚Ù…)
    document.getElementById('product-search').addEventListener('keydown', function(e) {
        if (e.key === 'Enter' || this.value.length === 12) {
            const results = searchProducts(this.value);
            if (results.length === 1) {
                addToCart(results[0].id);
            } else if (results.length > 1) {
                // Ø¥Ø°Ø§ Ø£ÙƒØ«Ø± Ù…Ù† Ù…Ù†ØªØ¬ØŒ Ø£Ø¶Ù Ø£ÙˆÙ„ Ù†ØªÙŠØ¬Ø© (Ø£Ùˆ ÙŠÙ…ÙƒÙ†Ùƒ Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø©)
                addToCart(results[0].id);
            }
            // ØªÙØ±ÙŠØº Ø®Ø§Ù†Ø© Ø§Ù„Ø¨Ø­Ø«
            this.value = '';
            document.getElementById('search-results').innerHTML = '';
        }
    });
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ø®ØµÙ…
    document.getElementById('cart-discount').addEventListener('input', updateTotals);
    renderCart();
});

// Ø²Ø± Ù…Ø³Ø­ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ (placeholder)
document.getElementById('scan-barcode-btn').addEventListener('click', function() {
    alert('Ù…ÙŠØ²Ø© Ø§Ù„Ù…Ø³Ø­ Ø¨Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø³ØªØ¶Ø§Ù Ù„Ø§Ø­Ù‚Ù‹Ø§! ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ ÙŠØ¯ÙˆÙŠÙ‹Ø§ Ø§Ù„Ø¢Ù†.');
});
</script>
{% endblock %}