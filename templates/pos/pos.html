
{% extends 'base.html' %}
{% block content %}
<div class="container-fluid" dir="rtl">
    <div class="row mt-4">
        <div class="col-lg-7"> <!-- تكبير عرض سلة البيع -->
            <div class="card shadow-sm mb-3">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-cart4"></i> نقطة البيع - فرع {{ current_user.get_branch_name() }}</h5>
                </div>
                <div class="card-body">
                    <!-- البحث عن منتج -->
                    <div class="input-group mb-3">
                        <input type="text" class="form-control form-control-lg text-end" id="product-search" placeholder="ابحث عن منتج بالاسم أو الباركود...">
                        <button class="btn btn-outline-secondary" type="button" id="scan-barcode-btn"><i class="bi bi-upc-scan"></i> مسح باركود</button>
                    </div>
                    <!-- نتائج البحث -->
                    <div id="search-results" class="list-group mb-3"></div>
                </div>
            </div>
        </div>
        <div class="col-lg-5"> <!-- تقليل عرض عمود السلة -->
            <!-- ملخص اليوم -->
            <div class="card shadow-sm mb-3">
                <div class="card-header bg-info text-white">
                    <i class="bi bi-bar-chart-line"></i> ملخص مبيعات اليوم
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between mb-2">
                        <span>عدد الفواتير:</span>
                        <span class="fw-bold">{{ sales_count or 0 }}</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>إجمالي المبيعات:</span>
                        <span class="fw-bold text-success">{{ '%.2f'|format(total_sales or 0) }} ج.م</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>إجمالي الخصومات:</span>
                        <span class="fw-bold text-danger">{{ '%.2f'|format(total_discount or 0) }} ج.م</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>إجمالي المدفوع:</span>
                        <span class="fw-bold text-primary">{{ '%.2f'|format(total_paid or 0) }} ج.م</span>
                    </div>
                </div>
            </div>
            <!-- نهاية ملخص اليوم -->
            <div class="card shadow-sm mb-3">
                <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                    <h6 class="mb-0"><i class="bi bi-basket"></i> سلة البيع</h6>
                    <a href="{{ url_for('pos.sales_list') }}" class="btn btn-outline-light btn-sm"><i class="bi bi-receipt"></i> الفواتير</a>
                </div>
                <div class="card-body">
                    <div id="cart-items"></div>
                    <hr>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>الإجمالي:</span>
                        <span class="fw-bold" id="cart-total">0.00</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>الخصم:</span>
                        <input type="number" class="form-control form-control-sm w-50 text-end" id="cart-discount" value="0" min="0">
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>المبلغ المستحق:</span>
                        <span class="fw-bold text-primary" id="cart-payable">0.00</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>نوع البيع:</span>
                        <select id="sale-type" class="form-select form-select-sm w-50 text-end">
                            <option value="cash">نقدي</option>
                            <option value="credit">آجل (دفتر)</option>
                        </select>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>التاجر/العميل:</span>
                        <input type="text" class="form-control form-control-sm w-50 text-end" id="customer-name" placeholder="اسم التاجر أو العميل (اختياري)">
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>رقم العميل:</span>
                        <input type="text" class="form-control form-control-sm w-50 text-end" id="customer-phone" placeholder="رقم الهاتف (اختياري)">
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>ملاحظة:</span>
                        <input type="text" class="form-control form-control-sm w-50 text-end" id="sale-note" placeholder="أدخل جملة أو تعليق (اختياري)">
                    </div>
                    <button class="btn btn-success w-100 btn-lg mt-3" id="checkout-btn"><i class="bi bi-cash-coin"></i> إتمام البيع</button>
                </div>
            </div>
        </div>
    </div>
    <!-- نافذة مسح الباركود (لاحقاً) -->
</div>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
<style>
/* تكبير عرض سلة البيع */
#cart-items .d-flex {
    font-size: 1.15rem;
    padding: 8px 0;
}
#cart-items .fw-bold {
    font-size: 1.1rem;
}
#cart-items .btn {
    font-size: 1rem;
    padding: 2px 8px;
}
</style>
<script>
let products = [];
let cart = [];

// جلب المنتجات المتوفرة في الفرع
async function fetchProducts() {
    const res = await fetch('/pos/api/products');
    products = await res.json();
}

// البحث عن منتج
function searchProducts(query) {
    query = query.trim().toLowerCase();
    if (!query) return [];
    return products.filter(p =>
        (p.name && p.name.toLowerCase().includes(query)) || (p.barcode && p.barcode.includes(query))
    );
}

// عرض نتائج البحث
function renderSearchResults(results) {
    const resultsDiv = document.getElementById('search-results');
    resultsDiv.innerHTML = '';
    if (results.length === 0) {
        resultsDiv.innerHTML = '<div class="alert alert-warning text-center">لا يوجد منتج مطابق للبحث</div>';
        return;
    }
    results.forEach(p => {
        const item = document.createElement('button');
        item.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center';
        item.innerHTML = `<span class='fw-bold'>${p.name}</span><span class='badge bg-primary'>${p.price} ج.م</span> <span class='text-muted small'>باركود: ${p.barcode}</span> <button class='btn btn-sm btn-outline-dark ms-2' onclick='event.stopPropagation();showBarcode("${p.barcode}")'><i class='bi bi-upc'></i></button>`;
        item.onclick = () => addToCart(p.id);
        resultsDiv.appendChild(item);
    });
}

// عند اختيار منتج من نتائج البحث أو إدخال باركود، أضفه للسلة وافرغ خانة البحث
function addToCart(productId) {
    const prod = products.find(p => p.id === productId);
    if (!prod) return;
    let item = cart.find(i => i.id === productId);
    if (item) {
        if (item.quantity < prod.quantity) {
            item.quantity++;
        }
    } else {
        cart.push({ ...prod, quantity: 1 });
    }
    renderCart();
    // تفريغ خانة البحث تلقائياً
    document.getElementById('product-search').value = '';
    document.getElementById('search-results').innerHTML = '';
    document.getElementById('product-search').focus();
}

// عرض السلة
function renderCart() {
    const cartDiv = document.getElementById('cart-items');
    cartDiv.innerHTML = '';
    if (cart.length === 0) {
        cartDiv.innerHTML = '<div class="alert alert-info text-center">سلة البيع فارغة</div>';
        return;
    }
    cart.forEach(item => {
        const row = document.createElement('div');
        row.className = 'd-flex justify-content-between align-items-center mb-2 border-bottom pb-1';
        row.innerHTML = `
            <span class='fw-bold'>${item.name}</span>
            <div>
                <button class='btn btn-sm btn-outline-secondary' onclick='changeQty(${item.id}, -1)'>-</button>
                <span class='mx-2'>${item.quantity}</span>
                <button class='btn btn-sm btn-outline-secondary' onclick='changeQty(${item.id}, 1)'>+</button>
                <span class='ms-3 text-success fw-bold'>${(item.price * item.quantity).toFixed(2)} ج.م</span>
                <button class='btn btn-sm btn-outline-dark ms-2' onclick='showBarcode("${item.barcode}")'><i class='bi bi-upc'></i></button>
                <button class='btn btn-sm btn-outline-danger ms-2' onclick='removeFromCart(${item.id})'><i class='bi bi-trash'></i></button>
            </div>
        `;
        cartDiv.appendChild(row);
    });
    updateTotals();
}

// تغيير كمية منتج في السلة
function changeQty(productId, delta) {
    let item = cart.find(i => i.id === productId);
    const prod = products.find(p => p.id === productId);
    if (!item || !prod) return;
    let newQty = item.quantity + delta;
    if (newQty < 1) newQty = 1;
    if (newQty > prod.quantity) newQty = prod.quantity;
    item.quantity = newQty;
    renderCart();
}

// إزالة منتج من السلة
function removeFromCart(productId) {
    cart = cart.filter(i => i.id !== productId);
    renderCart();
}

// تحديث الإجمالي
function updateTotals() {
    let total = cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
    document.getElementById('cart-total').textContent = total.toFixed(2);
    let discount = parseFloat(document.getElementById('cart-discount').value) || 0;
    let payable = total - discount;
    if (payable < 0) payable = 0;
    document.getElementById('cart-payable').textContent = payable.toFixed(2);
}

// عند إتمام البيع، أرسل نوع البيع واسم العميل والملاحظة مع البيانات
async function checkout() {
    if (cart.length === 0) {
        alert('السلة فارغة!');
        return;
    }
    let discount = parseFloat(document.getElementById('cart-discount').value) || 0;
    let paid = parseFloat(document.getElementById('cart-payable').textContent) || 0;
    let saleType = document.getElementById('sale-type').value;
    let customerName = document.getElementById('customer-name').value.trim();
    let saleNote = document.getElementById('sale-note').value.trim();
    let customerPhone = document.getElementById('customer-phone').value.trim();
    const res = await fetch('/pos/api/checkout', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({items: cart, discount, paid, sale_type: saleType, customer_name: customerName, customer_phone: customerPhone, note: saleNote})
    });
    const data = await res.json();
    if (data.success) {
        alert('تمت عملية البيع بنجاح!');
        printReceipt(cart, discount, paid, customerName, saleType, saleNote);
        cart = [];
        renderCart();
        document.getElementById('product-search').value = '';
        document.getElementById('search-results').innerHTML = '';
        await fetchProducts();
    } else {
        alert(data.message || 'حدث خطأ أثناء البيع');
    }
}
document.getElementById('checkout-btn').addEventListener('click', checkout);

function showBarcode(barcode) {
    if (!barcode) { alert('لا يوجد باركود'); return; }
    const img = document.createElement('img');
    img.src = `/static/barcodes/${barcode}.png`;
    img.style.maxWidth = '300px';
    img.style.display = 'block';
    img.style.margin = '20px auto';
    const win = window.open('', '_blank');
    win.document.write('<h3>باركود المنتج</h3>');
    win.document.body.appendChild(img);
}

// دالة طباعة الفاتورة
function printReceipt(cart, discount, paid, customerName, saleType, saleNote) {
    const branchName = document.querySelector('.card-header.bg-primary')?.textContent.trim() || '';
    const cashier = '{{ current_user.full_name or current_user.username }}';
    const now = new Date();
    const dateStr = now.toLocaleDateString('ar-EG') + ' ' + now.toLocaleTimeString('ar-EG');
    const invoiceNum = Math.floor(Math.random() * 1000000); // رقم عشوائي مؤقت
    // عناوين الفروع
    let branchAddress = '';
    if (branchName.includes('عبد العزيز')) {
        branchAddress = 'دسوق شارع عبد العزيز / ٠٤٧٢٥٥٠٣٠٥';
    } else if (branchName.includes('المركز')) {
        branchAddress = 'دسوق شارع المركز / ٠٤٧٢٥٥٥٥٢٤';
    } else if (branchName.includes('كفر الشيخ')) {
        branchAddress = 'كفر الشيخ - شارع المصنع بجوار ابراج الجبالي / ٠٤٧٣٢٢٢٩٣٥';
    } else {
        branchAddress = '';
    }
    let html = `<div style='font-family: Cairo, Arial, sans-serif; width:320px; margin:auto; text-align:center;'>`;
    html += `<img src='/static/logo2.png' style='max-width:90px; margin-bottom:8px; border-radius:8px;'>`;
    html += `<h3 style='margin:0 0 4px 0; letter-spacing:1px; color:#222;'>فاتورة بيع</h3>`;
    html += `<div style='font-size:15px; font-weight:bold; color:#0d6efd;'>${branchName}</div>`;
    if (branchAddress) html += `<div style='font-size:12px; color:#444; margin-bottom:2px;'>${branchAddress}</div>`;
    html += `<div style='font-size:12px; color:#555;'>${dateStr} | رقم: ${invoiceNum}</div>`;
    html += `<div style='font-size:12px; color:#555; margin-bottom:4px;'>الكاشير: ${cashier}</div>`;
    html += `<table style='width:100%; border-collapse:collapse; margin-bottom:10px; font-size:13px;'>`;
    html += `<tr style='background:#f2f2f2; color:#222;'>`;
    html += `<th style='border:1px solid #eee; padding:4px;'>المنتج</th><th style='border:1px solid #eee; padding:4px;'>الكمية</th><th style='border:1px solid #eee; padding:4px;'>السعر</th>`;
    html += `</tr>`;
    cart.forEach(item => {
        html += `<tr>`;
        html += `<td style='border:1px solid #eee; padding:4px;'>${item.name}</td>`;
        html += `<td style='border:1px solid #eee; padding:4px;'>${item.quantity}</td>`;
        html += `<td style='border:1px solid #eee; padding:4px;'>${(item.price * item.quantity).toFixed(2)} ج.م</td>`;
        html += `</tr>`;
    });
    html += `</table>`;
    html += `<div style='border-top:1px dashed #bbb; margin:8px 0;'></div>`;
    let total = cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
    html += `<div style='font-size:15px; text-align:right; color:#222; margin-bottom:2px;'>الإجمالي: <b>${total.toFixed(2)} ج.م</b></div>`;
    html += `<div style='font-size:13px; text-align:right; color:#444;'>الخصم: <b>${discount.toFixed(2)} ج.م</b></div>`;
    html += `<div style='font-size:13px; text-align:right; color:#444;'>المدفوع: <b>${paid.toFixed(2)} ج.م</b></div>`;
    html += `<div style='font-size:13px; text-align:right; color:#444;'>الباقي: <b>${(total-discount-paid).toFixed(2)} ج.م</b></div>`;
    html += `<div style='margin:10px 0 0 0; font-size:13px; color:#0d6efd; font-weight:bold;'>شكراً لتعاملكم معنا! 🌟</div>`;
    html += `<div style='font-size:12px; color:#888; margin-top:4px;'>نتمنى لكم يومًا سعيدًا</div>`;
    html += `<div style='font-size:12px; margin-top:6px;'>نوع البيع: ${saleType === 'cash' ? 'نقدي' : 'آجل (دفتر)'}</div>`;
    if (customerName) html += `<div style='font-size:12px;'>العميل/التاجر: ${customerName}</div>`;
    if (saleNote) html += `<div style='font-size:12px;'>ملاحظة: ${saleNote}</div>`;
    html += `</div>`;
    let win = window.open('', '_blank', 'width=350,height=600');
    win.document.write(html);
    setTimeout(() => {
        win.print();
        setTimeout(() => {
            win.close();
            location.reload();
        }, 1500);
    }, 800);
}

document.addEventListener('DOMContentLoaded', async function() {
    await fetchProducts();
    // البحث التلقائي
    document.getElementById('product-search').addEventListener('input', function() {
        const results = searchProducts(this.value);
        renderSearchResults(results);
    });
    // إضافة تلقائية عند مسح باركود (Enter أو طول 12 رقم)
    document.getElementById('product-search').addEventListener('keydown', function(e) {
        if (e.key === 'Enter' || this.value.length === 12) {
            const results = searchProducts(this.value);
            if (results.length === 1) {
                addToCart(results[0].id);
            } else if (results.length > 1) {
                // إذا أكثر من منتج، أضف أول نتيجة (أو يمكنك عرض رسالة)
                addToCart(results[0].id);
            }
            // تفريغ خانة البحث
            this.value = '';
            document.getElementById('search-results').innerHTML = '';
        }
    });
    // تحديث الإجمالي عند تغيير الخصم
    document.getElementById('cart-discount').addEventListener('input', updateTotals);
    renderCart();
});

// زر مسح الباركود (placeholder)
document.getElementById('scan-barcode-btn').addEventListener('click', function() {
    alert('ميزة المسح بالكاميرا ستضاف لاحقًا! يمكنك البحث بالباركود يدويًا الآن.');
});
</script>
{% endblock %}